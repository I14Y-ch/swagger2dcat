{% extends 'base.html' %}

{% block title %}Review and Edit Metadata{% endblock %}

{% block content %}
<div class="container">
    <h1>Review and Edit Metadata</h1>
    <p class="lead">
        Review the extracted metadata and make any necessary adjustments. You can use AI to generate a description based on the information provided below. Note: The form data will be sent to the AI provider OpenAI for processing.
    </p></p>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">API Information</h3>
        </div>            <div class="card-body">
                <div class="mb-3">
                    <strong>Swagger URL:</strong> <a href="{{ swagger_url }}" target="_blank">{{ swagger_url }}</a>
                </div>
                {% if landing_page_url %}
                <div class="mb-3">
                    <strong>Landing Page URL:</strong> <a href="{{ landing_page_url }}" target="_blank">{{ landing_page_url }}</a>
                    <small class="text-muted d-block">Content from this page has been extracted and added to the description field.</small>
                </div>
                {% endif %}
            </div>
    </div>

    <form id="apiDetailsForm" method="POST" action="/save_api_details">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="mb-0">API Details</h3>
                <button type="button" id="generateBtn" class="btn btn-light">
                    <span id="loadingSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    Generate with AI
                </button>
            </div>
            <div class="card-body">
                <!-- Title field -->
                <div class="mb-3">
                    <label for="title" class="form-label">Title:</label>
                    <input type="text" class="form-control" id="title" name="title" value="{{ title }}">
                    <small class="form-text text-muted">Pre-filled from Swagger information</small>
                </div>
                
                <!-- Description field -->
                <div class="mb-3">
                    <label for="description" class="form-label">Description:</label>
                    <textarea class="form-control" id="description" name="description" rows="12">{{ description }}</textarea>
                    <small class="form-text text-muted">Pre-filled with Swagger description, landing page content, version, and endpoint information</small>
                </div>
                
                <!-- Keywords field -->
                <div class="mb-3">
                    <label for="keywords" class="form-label">Keywords (comma-separated):</label>
                    <input type="text" class="form-control" id="keywords" name="keywords" value="{{ keywords }}">
                    <small class="form-text text-muted">Enter keywords separated by commas. You may want to refine them later using the keyword generation from the I14Y toolbox.</small>
                </div>
                
                <!-- Theme codes multi-select -->
                <div class="mb-3">
                    <label for="theme_codes" class="form-label">Theme Categories:</label>
                    <select class="form-select" id="theme_codes" name="theme_codes" multiple size="8">
                        <option value="101" {% if "101" in theme_codes %}selected{% endif %}>101 | Labour</option>
                        <option value="102" {% if "102" in theme_codes %}selected{% endif %}>102 | Construction</option>
                        <option value="103" {% if "103" in theme_codes %}selected{% endif %}>103 | Education</option>
                        <option value="104" {% if "104" in theme_codes %}selected{% endif %}>104 | External relations</option>
                        <option value="105" {% if "105" in theme_codes %}selected{% endif %}>105 | Jurisdiction</option>
                        <option value="106" {% if "106" in theme_codes %}selected{% endif %}>106 | Society</option>
                        <option value="107" {% if "107" in theme_codes %}selected{% endif %}>107 | Political activities</option>
                        <option value="108" {% if "108" in theme_codes %}selected{% endif %}>108 | Culture</option>
                        <option value="109" {% if "109" in theme_codes %}selected{% endif %}>109 | Agriculture</option>
                        <option value="110" {% if "110" in theme_codes %}selected{% endif %}>110 | Infrastructure</option>
                        <option value="111" {% if "111" in theme_codes %}selected{% endif %}>111 | Security</option>
                        <option value="112" {% if "112" in theme_codes %}selected{% endif %}>112 | Taxes</option>
                        <option value="113" {% if "113" in theme_codes %}selected{% endif %}>113 | Environment</option>
                        <option value="114" {% if "114" in theme_codes %}selected{% endif %}>114 | Health</option>
                        <option value="115" {% if "115" in theme_codes %}selected{% endif %}>115 | Economy</option>
                        <option value="116" {% if "116" in theme_codes %}selected{% endif %}>116 | Mobility</option>
                        <option value="117" {% if "117" in theme_codes %}selected{% endif %}>117 | Citizens</option>
                        <option value="118" {% if "118" in theme_codes %}selected{% endif %}>118 | Businesses</option>
                        <option value="119" {% if "119" in theme_codes %}selected{% endif %}>119 | Authorities</option>
                        <option value="120" {% if "120" in theme_codes %}selected{% endif %}>120 | Buildings and land</option>
                        <option value="121" {% if "121" in theme_codes %}selected{% endif %}>121 | Animals</option>
                        <option value="122" {% if "122" in theme_codes %}selected{% endif %}>122 | Geoinformation</option>
                        <option value="123" {% if "123" in theme_codes %}selected{% endif %}>123 | Compilation of laws</option>
                        <option value="124" {% if "124" in theme_codes %}selected{% endif %}>124 | Energy</option>
                        <option value="125" {% if "125" in theme_codes %}selected{% endif %}>125 | Official statistics</option>
                        <option value="126" {% if "126" in theme_codes %}selected{% endif %}>126 | Social security</option>
                    </select>
                    <small class="form-text text-muted">Hold Ctrl (or Cmd on Mac) to select multiple themes</small>
                </div>
                
                <!-- Access Rights Selection -->
                <div class="mb-3">
                    <label for="access_rights_code" class="form-label">
                        <i class="bi bi-shield-check"></i> Access Rights *
                    </label>
                    <select class="form-select" id="access_rights_code" name="access_rights_code" required>
                        {% for option in access_rights_options %}
                            <option value="{{ option.code }}" 
                                    {% if access_rights_code == option.code %}selected{% endif %}>
                                {{ option.label }}
                            </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Select the appropriate access level for this API</div>
                </div>

                <!-- License Selection -->
                <div class="mb-3">
                    <label for="license_code" class="form-label">
                        <i class="bi bi-file-text"></i> License
                    </label>
                    <select class="form-select" id="license_code" name="license_code">
                        {% for option in license_options %}
                            <option value="{{ option.code }}" 
                                    {% if license_code == option.code %}selected{% endif %}>
                                {{ option.label }}
                            </option>
                        {% endfor %}
                    </select>
                    <div class="form-text">Select the license that applies to this API (optional)</div>
                </div>

                <!-- Publisher Selection -->
                <div class="mb-3">
                    <label for="agency" class="form-label">
                        <i class="bi bi-building"></i> Publisher *
                    </label>
                    <select class="form-select" id="agency" name="agency" {% if not agents %}disabled{% endif %}>
                        {% if not agents %}
                            <option value="">No publishers available</option>
                        {% else %}
                            <option value="">-- Select a Publisher --</option>
                            {% for agent in agents %}
                                <option value="{{ agent.id }}" {% if agent.id == selected_agency %}selected{% endif %}>{{ agent.display_name }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                    <small class="form-text text-muted">Select the organization that publishes this API</small>
                </div>
            </div>
        </div>

        <div class="form-group mb-4">
            <div class="d-flex justify-content-between">
                <a href="{{ url_for('url') }}" class="btn btn-secondary">Back</a>
                <button type="submit" class="btn btn-primary">Translate & Review</button>
            </div>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const titleField = document.getElementById('title');
    const descriptionField = document.getElementById('description');
    const keywordsField = document.getElementById('keywords');
    const themeCodesField = document.getElementById('theme_codes');
    
    generateBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        // Show loading state
        generateBtn.disabled = true;
        loadingSpinner.classList.remove('d-none');
        generateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Generating...';
        
        // Call the generate API endpoint
        fetch('/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                // Fill the form fields with the generated data
                titleField.value = data.title || '';
                descriptionField.value = data.description || '';
                
                // Handle keywords
                if (Array.isArray(data.keywords)) {
                    keywordsField.value = data.keywords.join(', ');
                } else if (data.keywords) {
                    keywordsField.value = data.keywords;
                }
                
                // Handle theme codes
                for (let i = 0; i < themeCodesField.options.length; i++) {
                    themeCodesField.options[i].selected = false;
                }
                if (Array.isArray(data.theme_codes)) {
                    data.theme_codes.forEach(function(code) {
                        for (let i = 0; i < themeCodesField.options.length; i++) {
                            if (themeCodesField.options[i].value === code) {
                                themeCodesField.options[i].selected = true;
                            }
                        }
                    });
                } else if (data.theme_code) {
                    for (let i = 0; i < themeCodesField.options.length; i++) {
                        if (themeCodesField.options[i].value === data.theme_code) {
                            themeCodesField.options[i].selected = true;
                        }
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while generating content.');
        })
        .finally(() => {
            // Reset button state
            generateBtn.disabled = false;
            loadingSpinner.classList.add('d-none');
            generateBtn.innerHTML = 'Generate with AI';
        });
    });
});
</script>
{% endblock %}