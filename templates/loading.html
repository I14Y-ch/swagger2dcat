{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8 text-center">
            <div class="card">
                <div class="card-body p-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h4 class="mb-3">Processing API Information</h4>
                    <p class="text-muted" id="loadingStatus">Processing your API...</p>
                    
                    <div class="progress mb-3">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 15%;" aria-valuenow="15" aria-valuemin="0" aria-valuemax="100">15%</div>
                    </div>
                    
                    <div class="mt-3 text-start small">
                        <div id="step1" class="d-flex align-items-center mb-2">
                            <div class="spinner-border spinner-border-sm text-primary me-2" style="width: 1rem; height: 1rem;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span>Step 1: Parsing Swagger definition...</span>
                        </div>
                        <div id="step2" class="d-flex align-items-center mb-2 text-muted">
                            <div class="spinner-border spinner-border-sm text-muted me-2 d-none" style="width: 1rem; height: 1rem;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="me-2">⬜</span>
                            <span>Step 2: Processing landing page (if provided)...</span>
                        </div>
                        <div id="step3" class="d-flex align-items-center mb-2 text-muted">
                            <div class="spinner-border spinner-border-sm text-muted me-2 d-none" style="width: 1rem; height: 1rem;" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="me-2">⬜</span>
                            <span>Step 3: Loading metadata...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Variables to track steps
let currentStep = 1;
let checkCount = 0;
let progressValue = 15;

// Update the progress bar
function updateProgress(value, status) {
    document.getElementById('progressBar').style.width = value + '%';
    document.getElementById('progressBar').innerText = value + '%';
    document.getElementById('progressBar').setAttribute('aria-valuenow', value);
    document.getElementById('loadingStatus').textContent = status;
}

// Mark a step as completed
function completeStep(stepNum) {
    const stepElement = document.getElementById('step' + stepNum);
    stepElement.querySelector('.spinner-border').classList.add('d-none');
    stepElement.querySelector('span:first-of-type').textContent = '✅';
    stepElement.classList.remove('text-muted');
    stepElement.classList.add('text-success');
}

// Start a step
function startStep(stepNum) {
    const stepElement = document.getElementById('step' + stepNum);
    stepElement.querySelector('.spinner-border').classList.remove('d-none');
    stepElement.querySelector('span:first-of-type').textContent = '';
    stepElement.classList.remove('text-muted');
}

// Check processing status every 2 seconds
const checkInterval = setInterval(function() {
    fetch('/check_processing_status?processing_id={{ request.args.get("workflow_id") or session.get("processing_id", "") }}')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'complete') {
                clearInterval(checkInterval);
                // Complete all steps
                completeStep(1);
                completeStep(2);
                completeStep(3);
                updateProgress(100, 'Complete! Redirecting...');
                setTimeout(() => {
                    window.location.href = '/ai';
                }, 500);
            } else if (data.status === 'error') {
                clearInterval(checkInterval);
                document.getElementById('loadingStatus').innerHTML = '<span class="text-danger">Error: ' + data.message + '</span>';
                
                // Mark current step as failed
                const stepElement = document.getElementById('step' + currentStep);
                stepElement.querySelector('.spinner-border').classList.add('d-none');
                stepElement.querySelector('span:first-of-type').textContent = '❌';
                stepElement.classList.remove('text-muted');
                stepElement.classList.add('text-danger');
                
                setTimeout(() => {
                    window.location.href = '/url?error=' + encodeURIComponent(data.message);
                }, 3000);
            } else if (data.status === 'processing' && data.progress) {
                // Update progress based on server information
                const progress = data.progress;
                
                // Update the progress bar
                updateProgress(progress.percent, progress.message || 'Processing your API...');
                
                // Update steps based on current_step
                if (progress.current_step.includes('Parsing Swagger')) {
                    if (currentStep !== 1) {
                        startStep(1);
                        currentStep = 1;
                    }
                } else if (progress.current_step.includes('Processing landing')) {
                    if (currentStep === 1) {
                        completeStep(1);
                        startStep(2);
                        currentStep = 2;
                    }
                } else if (progress.current_step.includes('Loading metadata') || 
                           progress.current_step.includes('Finalizing')) {
                    if (currentStep === 1) {
                        completeStep(1);
                        startStep(3);
                        currentStep = 3;
                    } else if (currentStep === 2) {
                        completeStep(2);
                        startStep(3);
                        currentStep = 3;
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error checking status:', error);
        });
}, 2000);
</script>
{% endblock %}
